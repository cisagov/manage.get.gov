# Manually deploy a branch of choice to an environment of choice.

name: Manual Build and Deploy
run-name: Manually build and deploy branch to sandbox of choice

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'backup'
        type: 'choice'
        options:
          - aa
          - acadia
          - ad
          - backup
          - ap
          - cw
          - testdb
          - dg
          - el
          - es
          - glacier
          - hotgov
          - kma
          - litterbox
          - meoward
          - nl
          - olympic
          - potato
          - product
          - rh
          - yellowstone
          - zion

      # GitHub Actions has no "good" way yet to dynamically input branches
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string
      

jobs:
  variables:
    runs-on: ubuntu-latest
    steps:
      - name: Setting global variables
        uses: actions/github-script@v6
        id: var
        with:
          script: |
            core.setOutput('environment', '${{ github.head_ref }}'.split("/")[0]);
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Compile USWDS assets
        working-directory: ./src
        run: |
          docker compose run node npm install npm@latest &&
          docker compose run node npm install &&
          docker compose run node npx gulp copyAssets &&
          docker compose run node npx gulp compile
      - name: Collect static assets 
        working-directory: ./src
        run: docker compose run app python manage.py collectstatic --no-input
      - name: Deploy to cloud.gov sandbox
        uses: cloud-gov/cg-cli-tools@main
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          CF_USERNAME: CF_${{ github.event.inputs.environment }}_USERNAME
          CF_PASSWORD: CF_${{ github.event.inputs.environment }}_PASSWORD
        with:
          cf_username: ${{ secrets[env.CF_USERNAME] }}
          cf_password: ${{ secrets[env.CF_PASSWORD] }}
          cf_org: cisa-dotgov
          cf_space: ${{ env.ENVIRONMENT }}
          cf_manifest: ops/manifests/manifest-${{ env.ENVIRONMENT }}.yaml
      - name: Install CF CLI and cg-manage-rds
        run: | 
            wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo gpg --dearmor -o /usr/share/keyrings/cli.cloudfoundry.org.gpg
            echo "deb [signed-by=/usr/share/keyrings/cli.cloudfoundry.org.gpg] https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list

            sudo apt-get update
            sudo apt-get install cf8-cli
            
            # install cg-manage-rds tool
            pip install git+https://github.com/cloud-gov/cg-manage-rds.git
      - name: Copy github info to .env
        env: 
          CF_USERNAME: CF_${{ github.event.inputs.environment }}_USERNAME
          CF_PASSWORD: CF_${{ github.event.inputs.environment }}_PASSWORD
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |
          # Authenticate 
          CF_USER=${{ secrets[env.CF_USERNAME] }}
          CF_PASS=${{ secrets[env.CF_PASSWORD] }}

          cf api api.fr.cloud.gov
          cf auth "$CF_USER" "$CF_PASS"
          cf target -o cisa-dotgov -s $ENVIRONMENT

          cf set-env $ENVIRONMENT GIT_BRANCH "${{ github.event.inputs.branch }}"
          cf set-env $ENVIRONMENT GIT_COMMIT "${{ github.sha }}"
          cf set-env $ENVIRONMENT GIT_SHORT_COMMIT "${{ github.sha::7 }}"
          cf set-env $ENVIRONMENT GIT-REF "${{ github.ref_nam }}"
          
          # check if there is a tag
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            cf set-env $ENVIRONMENT GIT_TAG "${{ github.ref_name }}"
            cf set-env $ENVIRONMENT IS_TAG "true"
          else 
            cf set-env $ENVIRONMENT IS_TAG "false"
          fi

          #Restart to apply changes

          cf restage $ENVIRONMENT