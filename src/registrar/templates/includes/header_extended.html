{% load static %}
{% load custom_filters %}

{% if hide_portfolio_navbar %}
<header class="usa-header usa-header--extended usa-header__top-level-only">
{% else %}
<header class="usa-header usa-header--extended">
{% endif %}
    <div class="usa-navbar usa-navbar--widescreen padding-x--widescreen">
        {% include "includes/gov_extended_logo.html" with logo_clickable=logo_clickable %}
        <button type="button" class="usa-menu-btn">Menu</button>
    </div>
    {% block usa_nav %}
    {% get_user_nav_modes as nav_modes %}
    {% get_user_portfolios as user_portfolios %}
    <nav class="usa-nav" aria-label="Primary navigation">
        <button type="button" class="usa-nav__close">
            <img src="{%static 'img/usa-icons/close.svg'%}" class="close-icon" role="img" alt="Close" />
        </button>
        <div class="usa-nav__inner usa-nav__inner--widescreen padding-x--widescreen">
            <div class="usa-nav__secondary desktop-only">
                <ul class="usa-nav__secondary-links">
                    {% if has_multiple_portfolios %}
                    {% load nav_header %}
                    {% portfolio_organizations_dropdown %}
                    {% endif %}
                    {% if user.is_authenticated %}
                    <li class="usa-nav__secondary-item">
                        <div class="usa-accordion">
                            <div class="usa-accordion__heading usa-nav__secondary-menu">
                                <button
                                class="usa-button usa-nav__link usa-accordion__button navmenu-dropdown-button" 
                                id="user-profile-menu"
                                aria-controls="user-profile-submenu"
                                aria-expanded="false"
                                aria-label="user-profile-menu"
                                >
                                    <span class="ellipsis usa-nav__username">{{ user.email }}</span>
                                </button>
                            </div>
                            <div id="user-profile-submenu" class="usa-nav__submenu">
                                <div class="usa-nav__submenu-item">
                                    {% url 'user-profile' as user_profile_url %}
                                    {% url 'finish-user-profile-setup' as finish_setup_url %}
                                    <a class="usa-nav-link {% if path == user_profile_url or path == finish_setup_url %}usa-current{% endif %}" href="{{ user_profile_url }}">
                                        Your profile
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li> 
                    <li class="usa-nav__secondary-item">
                        <a class="usa-nav-link" href="{% url 'logout' %}">Sign out</a>
                    </li>
                    {% else %}
                    <li class="usa-nav__secondary-item">
                        <a class="usa-nav-link" href="{% url 'login' %}">Sign in</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
            <ul class="usa-nav__primary usa-accordion desktop-only">
                <li class="usa-nav__primary-item">
                    {% if has_any_domains_portfolio_permission %}
                        {% url 'domains' as url %}
                    {% else %}
                        {% url 'no-portfolio-domains' as url %}
                    {% endif %}
                    <a href="{{ url }}" class="usa-nav-link{% if path|is_domain_subpage %} usa-current{% endif %}"> 
                        Domains
                    </a>
                </li>
                <!-- <li class="usa-nav__primary-item">
                    <a href="#" class="usa-nav-link">
                        Domain groups
                    </a>
                </li> -->

                <li class="usa-nav__primary-item">
                    <!-- user has one of the view permissions plus the edit permission, show the dropdown -->
                    {% if has_edit_request_portfolio_permission %}
                        {% url 'domain-requests' as url %}
                        <button
                            type="button"
                            class="usa-accordion__button usa-nav__link{% if path|is_domain_request_subpage %} usa-current{% endif %}"
                            aria-expanded="false"
                            aria-controls="basic-nav-section-two"
                        >
                            <span>Domain requests</span>
                        </button>
                        <ul id="basic-nav-section-two" class="usa-nav__submenu">
                            <li class="usa-nav__submenu-item">
                                <a href="{{ url }}"
                                ><span>Domain requests</span></a
                                >
                            </li>
                            <li class="usa-nav__submenu-item">
                                <a href="{% url 'domain-request:start' %}"
                                ><span>Start a new domain request</span></a
                                >
                            </li>
                        </ul>
                <!-- user has view but no edit permissions -->
                    {% elif has_any_requests_portfolio_permission %}
                        {% url 'domain-requests' as url %}
                        <a href="{{ url }}" class="usa-nav-link{% if path|is_domain_request_subpage %} usa-current{% endif %}"> 
                            Domain requests
                        </a>
                <!-- user does not have permissions -->
                    {% else %}
                        {% url 'no-portfolio-requests' as url %}
                        <a href="{{ url }}" class="usa-nav-link{% if path|is_domain_request_subpage %} usa-current{% endif %}"> 
                        Domain requests
                        </a>
                    {% endif %}
                </li>

                {% if has_view_members_portfolio_permission %}
                <li class="usa-nav__primary-item">
                    <a href="{% url 'members' %}" class="usa-nav-link {% if path|is_members_subpage %} usa-current{% endif %}">
                        Members
                    </a>
                </li>
                {% endif %}

                <li class="usa-nav__primary-item">
                    {% url 'organization' as url %}
                    <!-- Move the padding from the a to the span so that the descenders do not get cut off -->
                    <a href="{{ url }}" class="usa-nav-link padding-y-0 {% if path|is_portfolio_subpage %} usa-current{% endif %}">
                        <div class="grid-container padding-left-0 padding-right-0">
                            <div class="grid-row flex-align-center">
                                <div class="logo-col grid-col-auto height-3">
                                    {% if portfolio.agency_seal %}
                                    <img 
                                        src="{{portfolio.agency_seal_url }}"
                                        alt=""
                                        class="margin-right-1 height-3"
                                    >
                                    {% else %}
                                    <img
                                        src="/public/img/registrar/organization_default_icon.png"
                                        alt=""
                                        class="margin-right-1 height-3"
                                    >
                                    {% endif %}
                                </div>
                                <div class="grid-col">
                                    <span 
                                        class="ellipsis ellipsis--desktop-50 padding-y-1 desktop:padding-y-2 organization-nav-link"
                                    >
                                        {{ portfolio.organization_name }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                </li>
            </ul>

            <ul class="usa-nav__primary usa-accordion mobile-only">
                {% if nav_modes.is_enterprise %}
                {% if user_portfolios|length > 1 %}
                {% for p in user_portfolios %}
                <li class="usa-nav__primary-item">
                    <button type="button" class="usa-accordion__button usa-nav__link" aria-expanded="false" aria-controls="portfolio-{{ forloop.counter }}">
                        <span>
                            {% if p.agency_seal_url %}
                            <img src="{{ p.agency_seal_url }}" alt="" class="margin-right-1 height-3">
                            {% endif %}
                            {{ p.organization_name }}
                        </span>
                    </button>
                    <ul id="portfolio-{{ forloop.counter }}" class="usa-nav__submenu">
                        <li class="usa-nav__submenu-item"><a href="{% url 'domains' %}"><span>Domains</span></a></li>
                        <li class="usa-nav__submenu-item">
                        {% if has_edit_request_portfolio_permission or has_any_requests_portfolio_permission %}
                            <a href="{% url 'domain-requests' %}"><span>Domain Requests</span></a></li>
                        {% else %}
                            <a href="{% url 'no-portfolio-requests' %}"><span>Domain Requests</span></a></li>
                        {% endif %}
                        </li>
                        {% if has_view_members_portfolio_permission %}
                        <li class="usa-nav__submenu-item"><a href="{% url 'members' %}"><span>Members</span></a></li>
                        {% endif %}
                        <li class="usa-nav__submenu-item"><a href="{% url 'organization' %}"><span>Organization</span></a></li>
                    </ul>
                </li>
                {% endfor %}
                {% else %}
                <li class="usa-nav__primary-item border-top-0">
                    {% with p=user_portfolios.0 %}
                    <button id="portfolio-single-button" type="button" class="usa-accordion__button usa-nav-link" aria-expanded="false" aria-controls="portfolio-single">
                        <span>
                            {% if p and p.agency_seal_url %}
                            <img src="{{ p.agency_seal_url }}" alt="" class="margin-right-1 height-3">
                            {% endif %}
                            {{ p.organization_name|default:portfolio.organization_name }}
                        </span>
                    </button>
                    {% endwith %}
                    <ul id="portfolio-single" class="usa-nav__submenu">
                        <li class="usa-nav__submenu-item"><a href="{% url 'domains' %}"><span>Domains</span></a></li>
                        <li class="usa-nav__submenu-item">
                        {% if has_edit_request_portfolio_permission or   has_any_requests_portfolio_permission %}
                            <a href="{% url 'domain-requests' %}"><span>Domain Requests</span></a></li>
                        {% else %}
                            <a href="{% url 'no-portfolio-requests' %}"><span>Domain Requests</span></a></li>
                        {% endif %}
                        </li>
                        {% if has_view_members_portfolio_permission %}
                        <li class="usa-nav__submenu-item"><a href="{% url 'members' %}"><span>Members</span></a></li>
                        {% endif %}
                        <li class="usa-nav__submenu-item"><a href="{% url 'organization' %}"><span>Organization</span></a></li>
                    </ul>
                </li>
                {% endif %}
                {% endif %}
                {% if nav_modes.is_both %}
                <li class="usa-nav__primary-item">
                    <a href="{% url 'no-portfolio-domains' %}" class="usa-nav-link">
                        {{ user.email }}'s account
                    </a>
                </li>
                {% endif %}
                <li class="usa-nav__primary-item margin-top-5 mobile-menu-profile">
                    <a href="{{ user_profile_url }}">
                        Your profile
                    </a>
                </li>
                <li class="usa-nav__primary-item display-flex flex-align-center mobile-menu-profile">
                    <a href="{{ logout }}">
                        Sign out
                    </a>
                    <img src="{%static 'img/usa-icons/logout.svg'%}" class="logout-icon" role="img" alt="Logout" />
                </li>
            </ul>
        </div>
    </nav>
    {% endblock %}
</header>
